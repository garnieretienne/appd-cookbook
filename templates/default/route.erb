#!/bin/bash
#
# Create an ninx vhost file
# Generate a domain name using the server fully qualified domain name and the application name
# Write the vhost in the HOME/routes directory (must exists)
# Output the application url
set -e

if [ -z "$1" ] || [ -z "$2" ]; then
  echo "Usage: route APP BACKEND:PORT [BACKEND:PORT]"
else
  app=$1
  backends="${@:2}"
  domain="${app}.$(hostname --fqdn)"

  # Build the nginx vhost
  vhost=$(cat <<EOF

# Nginx route for $app
# Generated by appd
upstream $app {
$(for backend in ${backends[@]}; do echo "  server ${backend};"; done)
}

server {
  listen 80;
  server_name ${domain};

  location / {
    proxy_pass http://${app};
  }
}

EOF
)

  echo "$vhost" > <%= node[:appd][:routes] %>/${app}
  <%= node[:appd][:update_routes_cmd] %>
  echo http://${domain}
fi